{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Add CSRF token at the top of your content -->
{% csrf_token %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Equipment Rentals - CareFusion</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    
    <style>
        /* Copy all the navbar-related styles from patients_dashboard.html */
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }

        /* Navbar Styles */
        .topbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 15px 0;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .logo img {
            height: 40px;
            object-fit: contain;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 2rem;
        }

        .nav-menu > li {
            position: relative;
            padding: 0.5rem 0;
        }

        .nav-menu a {
            color: white;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .nav-menu .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .nav-menu li:hover .dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .nav-menu .dropdown li {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-menu .dropdown a {
            color: #333;
            padding: 0.75rem 1rem;
            display: block;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-menu .dropdown a:hover {
            background-color: #f8f9fa;
            color: #1e3c72;
            padding-left: 1.5rem;
        }

        .nav-menu > li > a:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: white;
            transition: width 0.3s ease;
        }

        .nav-menu > li:hover > a:after {
            width: 100%;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
        }

        .user-info .btn-outline-light {
            border-color: rgba(255,255,255,0.5);
        }

        .user-info .btn-outline-light:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Add padding to body to prevent content from hiding under fixed navbar */
        body {
            padding-top: 80px;
            background-color: #f5f7fb;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-wrap: wrap;
            }

            .nav-menu {
                flex-direction: column;
                width: 100%;
                gap: 0.5rem;
            }

            .nav-menu .dropdown {
                position: static;
                opacity: 1;
                visibility: visible;
                transform: none;
                box-shadow: none;
                background: transparent;
                min-width: auto;
            }

            .nav-menu .dropdown a {
                color: white;
                padding-left: 1rem;
            }
        }

        /* Keep your existing styles below */
        /* ... rest of your existing styles ... */

        .rental-expired {
            border: 2px solid var(--warning-color);
        }

        .rental-expired .card-header {
            background-color: var(--warning-color) !important;
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="topbar">
        <div class="nav-container">
            <a href="{% url 'patients_dashboard' %}" class="logo">
                <img src="{% static 'img/logo.png' %}" alt="CareFusion" />
            </a>
            
            <ul class="nav-menu">
                <li>
                    <a href="{% url 'patient_rentals' %}">
                        <i class="bi bi-box-seam"></i> Equipment Rentals
                    </a>
                </li>
                <li>
                    <a href="#">
                        <i class="bi bi-calendar-check-fill"></i> Appointments
                        <i class="bi bi-chevron-down"></i>
                    </a>
                    <ul class="dropdown">
                        <li>
                            <a href="{% url 'upcoming_team_visits' %}">
                                <i class="bi bi-calendar2-week"></i> Team Visits
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#">
                        <i class="bi bi-file-medical-fill"></i> Health Records
                        <i class="bi bi-chevron-down"></i>
                    </a>
                    <ul class="dropdown">
                        <li>
                            <a href="#" onclick="scrollToSection('prescriptions-section')">
                                <i class="bi bi-capsule"></i> Prescriptions
                            </a>
                        </li>
                        <li>
                            <a href="#" onclick="scrollToSection('services-section')">
                                <i class="bi bi-clipboard2-pulse"></i> Services
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
            
            <div class="user-info">
                <span>
                    <i class="bi bi-person-circle"></i> {{ user.get_full_name }}
                </span>
                <a href="{% url 'logout' %}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div class="container mt-3">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Equipment Tabs -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-wheelchair me-2"></i>Medical Equipment Rentals
                </h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#available">
                            Available Equipment
                            <span class="badge bg-primary ms-2">{{ available_equipment.count }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#pending">
                            Pending Requests
                            <span class="badge bg-warning ms-2">{{ pending_rentals.count }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#active">
                            Active Rentals
                            <span class="badge bg-info ms-2">{{ active_rentals.count }}</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#history">
                            Rental History
                            <span class="badge bg-secondary ms-2">{{ rental_history.count }}</span>
                        </a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content mt-3">
                    <!-- Available Equipment -->
                    <div class="tab-pane fade show active" id="available">
                        <div class="row">
                            {% for equipment in available_equipment %}
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    {% if equipment.primary_image %}
                                    <img src="{{ equipment.primary_image.url }}" class="card-img-top" alt="{{ equipment.name }}">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ equipment.name }}</h5>
                                        <p class="card-text">{{ equipment.description|truncatewords:20 }}</p>
                                        <ul class="list-unstyled">
                                            <li><i class="fas fa-hospital me-2"></i>{{ equipment.organization.org_name }}</li>
                                            <li><i class="fas fa-tag me-2"></i>₹{{ equipment.rental_price_per_day }}/day</li>
                                            <li><i class="fas fa-shield-alt me-2"></i>Deposit: ₹{{ equipment.security_deposit }}</li>
                                            <li><i class="fas fa-info-circle me-2"></i>Condition: {{ equipment.get_condition_display }}</li>
                                        </ul>
                                        
                                        {% with pending_rental=equipment.equipmentrental_set.filter.first %}
                                            {% if pending_rental and pending_rental.status == 'PENDING' %}
                                                <button class="btn btn-warning btn-sm" disabled>
                                                    <i class="fas fa-clock me-1"></i> Waiting for Approval
                                                </button>
                                            {% elif pending_rental and pending_rental.status == 'DEPOSIT_PENDING' %}
                                                <button class="btn btn-info btn-sm" disabled>
                                                    <i class="fas fa-spinner fa-spin me-1"></i> Processing Deposit
                                                </button>
                                            {% else %}
                                                <button onclick="initiateRental({{ equipment.id }})" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-calculator me-1"></i> Calculate Rental
                                                </button>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No equipment available at the moment.
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Pending Requests Tab -->
                    <div class="tab-pane fade" id="pending">
                        <div class="row">
                            {% for rental in pending_rentals %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h5 class="card-title">{{ rental.equipment.name }}</h5>
                                            <span class="badge bg-{{ rental.status|lower }}">
                                                {{ rental.get_status_display }}
                                            </span>
                                        </div>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-hospital me-2"></i>{{ rental.equipment.organization.org_name }}
                                        </p>
                                        <div class="rental-details mt-3">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Start Date</small>
                                                    <p class="mb-2">{{ rental.rental_start_date|date:"M d, Y" }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted d-block">End Date</small>
                                                    <p class="mb-2">{{ rental.rental_end_date|date:"M d, Y" }}</p>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Daily Rate</small>
                                                    <p class="mb-2">₹{{ rental.daily_rental_price }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Security Deposit</small>
                                                    <p class="mb-2">₹{{ rental.deposit_amount }}</p>
                                                </div>
                                            </div>
                                            {% if rental.status == 'DEPOSIT_PENDING' %}
                                            <div class="alert alert-info mt-3">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Deposit payment is being processed
                                            </div>
                                            {% elif rental.status == 'PENDING' %}
                                            <div class="alert alert-warning mt-3">
                                                <i class="fas fa-clock me-2"></i>
                                                Waiting for organization approval
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No pending rental requests.
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Active Rentals -->
                    <div class="tab-pane fade" id="active">
                        <div class="row">
                            {% for rental in active_rentals %}
                            {% if rental.status != 'PENDING' and rental.status != 'DEPOSIT_PENDING' %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h5 class="card-title">{{ rental.equipment.name }}</h5>
                                            <span class="badge bg-{{ rental.status|lower }}">
                                                {{ rental.get_status_display }}
                                            </span>
                                        </div>
                                        <p class="text-muted mb-2">
                                            <i class="fas fa-hospital me-2"></i>{{ rental.equipment.organization.org_name }}
                                        </p>
                                        <div class="rental-details mt-3">
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted d-block">Start Date</small>
                                                    <p class="mb-2">{{ rental.rental_start_date|date:"M d, Y" }}</p>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted d-block">End Date</small>
                                                    <p class="mb-2">{{ rental.rental_end_date|date:"M d, Y" }}</p>
                                                </div>
                                            </div>
                                            {% if rental.delivery and rental.delivery.status != 'DELIVERED' %}
                                            <div class="delivery-tracking mt-3">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <div>
                                                        <h6>{{ rental.equipment.name }}</h6>
                                                        <p class="mb-1">
                                                            <i class="fas fa-user me-2"></i>
                                                            Volunteer: {{ rental.delivery.volunteer.get_full_name }}
                                                        </p>
                                                    </div>
                                                    <span class="badge bg-{{ rental.delivery.status|lower }}">
                                                        {{ rental.delivery.get_status_display }}
                                                    </span>
                                                </div>

                                                <!-- Delivery Progress Timeline -->
                                                <div class="delivery-timeline mb-3">
                                                    <div class="progress" style="height: 3px;">
                                                        <div class="progress-bar" role="progressbar" 
                                                             style="width: {% if rental.delivery.status == 'DELIVERED' %}100%
                                                                         {% elif rental.delivery.status == 'OTP_VERIFIED' %}80%
                                                                         {% elif rental.delivery.status == 'ARRIVED' %}60%
                                                                         {% elif rental.delivery.status == 'IN_PROGRESS' %}40%
                                                                         {% elif rental.delivery.status == 'ASSIGNED' %}20%
                                                                         {% else %}0%{% endif %}">
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-between mt-2">
                                                        <span class="badge {% if rental.delivery.status != 'PENDING' %}bg-success{% else %}bg-secondary{% endif %}">Assigned</span>
                                                        <span class="badge {% if rental.delivery.status == 'IN_PROGRESS' %}bg-success{% else %}bg-secondary{% endif %}">In Transit</span>
                                                        <span class="badge {% if rental.delivery.status == 'ARRIVED' %}bg-success{% else %}bg-secondary{% endif %}">Arrived</span>
                                                        <span class="badge {% if rental.delivery.status == 'DELIVERED' %}bg-success{% else %}bg-secondary{% endif %}">Delivered</span>
                                                    </div>
                                                </div>

                                                <!-- Live Tracking Map -->
                                                {% if rental.delivery.status == 'IN_PROGRESS' %}
                                                <div class="delivery-map mb-3" id="map-{{ rental.delivery.id }}" style="height: 200px;"></div>
                                                {% endif %}

                                                <!-- OTP Verification Section -->
                                                {% if rental.delivery.status == 'ARRIVED' %}
                                                <div class="otp-section alert alert-info">
                                                    <p class="mb-2"><strong>Delivery OTP:</strong> {{ rental.delivery.delivery_otp }}</p>
                                                    <small>Share this OTP with the volunteer to complete the delivery</small>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="rental-usage-details mt-3">
                                            <div class="card" id="rental-{{ rental.id }}" data-rental-id="{{ rental.id }}">
                                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                                    <h5 class="mb-0">Current Usage Details</h5>
                                                    <span class="badge bg-light text-dark">Rate: ₹{{ rental.daily_rental_price }}/day</span>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="usage-stats">
                                                                <h6>Usage Duration</h6>
                                                                <div class="d-flex align-items-center mb-3">
                                                                    <div class="h4 mb-0" id="usage-duration-{{ rental.id }}">
                                                                        {{ rental.get_usage_duration }}
                                                                    </div>
                                                                    <small class="text-muted ms-2">days</small>
                                                                </div>
                                                                
                                                                <h6>Current Bill Amount</h6>
                                                                <div class="h4 mb-3">₹<span id="current-amount-{{ rental.id }}">{{ rental.get_current_bill_amount }}</span></div>
                                                                
                                                                <div class="usage-period text-muted">
                                                                    <small>
                                                                        Start Date: {{ rental.rental_start_date|date:"M d, Y" }}<br>
                                                                        End Date: {{ rental.rental_end_date|date:"M d, Y" }}<br>
                                                                        Daily Rate: ₹{{ rental.daily_rental_price }}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="col-md-6">
                                                            <div class="usage-actions">
                                                                <h6>Actions</h6>
                                                                <div class="d-grid gap-2">
                                                                    {% if rental.status == 'END' %}
                                                                        <button class="btn btn-primary mb-2" onclick="payRentalBill({{ rental.id }})">
                                                                            <i class="fas fa-money-bill me-2"></i> Pay Rental Bill
                                                                            <span class="badge bg-light text-dark ms-2">₹{{ rental.get_current_bill_amount }}</span>
                                                                        </button>
                                                                        
                                                                        <button class="btn btn-warning mb-2" onclick="requestRentalExtension({{ rental.id }})">
                                                                            <i class="fas fa-clock me-2"></i> Extend Rental Period
                                                                        </button>
                                                                        
                                                                        <div class="alert alert-warning">
                                                                            <small>
                                                                                <i class="fas fa-info-circle me-2"></i>
                                                                                Your rental period has ended. Please either pay the bill or request an extension.
                                                                            </small>
                                                                        </div>
                                                                    {% elif rental.status == 'ACTIVE' %}
                                                                        <button class="btn btn-warning mb-2" onclick="requestRentalExtension({{ rental.id }})">
                                                                            <i class="fas fa-clock me-2"></i> Extend Rental Period
                                                                        </button>
                                                                        
                                                                        <div class="alert alert-info">
                                                                            <small>
                                                                                <i class="fas fa-info-circle me-2"></i>
                                                                                Current rental period ends on {{ rental.rental_end_date|date:"M d, Y" }}
                                                                            </small>
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {% comment %} <!-- Usage History -->
                                                    <div class="usage-history mt-4">
                                                        <h6>Usage History</h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Period</th>
                                                                        <th>Duration</th>
                                                                        <th>Amount</th>
                                                                        <th>Status</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="usage-history-{{ rental.id }}">
                                                                    {% for period in rental.get_usage_periods %}
                                                                    <tr>
                                                                        <td>{{ period.start_date|date }} - {{ period.end_date|date }}</td>
                                                                        <td>{{ period.duration }} days</td>
                                                                        <td>₹{{ period.amount }}</td>
                                                                        <td>
                                                                            <span class="badge bg-{{ period.status|lower }}">
                                                                                {{ period.status }}
                                                                            </span>
                                                                        </td>
                                                                    </tr>
                                                                    {% empty %}
                                                                    <tr>
                                                                        <td colspan="4" class="text-center text-muted">
                                                                            <small>No usage history available</small>
                                                                        </td>
                                                                    </tr>
                                                                    {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div> {% endcomment %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% empty %}
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No active rentals at the moment.
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Rental History -->
                    <div class="tab-pane fade" id="history" role="tabpanel">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Rental History</h5>
                            </div>
                            <div class="card-body">
                                {% for rental in rental_history %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <h6>{{ rental.equipment.name }}</h6>
                                                <p class="mb-1"><i class="fas fa-hospital me-2"></i>{{ rental.equipment.organization.org_name }}</p>
                                                <p class="mb-0"><i class="fas fa-calendar me-2"></i>{{ rental.created_at|date:"M d, Y" }}</p>
                                            </div>
                                            <div class="col-md-4">
                                                <p class="mb-1"><strong>Daily Rate:</strong> ₹{{ rental.daily_rental_price }}</p>
                                                <p class="mb-1"><strong>Security Deposit:</strong> ₹{{ rental.deposit_amount }}</p>
                                                {% if rental.rental_start_date %}
                                                <p class="mb-0">
                                                    <strong>Rental Period:</strong> 
                                                    {{ rental.rental_start_date|date:"M d, Y" }} - 
                                                    {{ rental.rental_end_date|date:"M d, Y" }}
                                                </p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="badge bg-{{ rental.status|lower }} mb-2">{{ rental.get_status_display }}</span>
                                                <p class="mb-0">
                                                    <small class="text-muted">
                                                        <i class="fas fa-money-check me-1"></i>
                                                        Payment: {{ rental.payment_status }}
                                                    </small>
                                                </p>
                                                {% if rental.razorpay_payment_id %}
                                                <small class="text-muted d-block">
                                                    <i class="fas fa-receipt me-1"></i>
                                                    Payment ID: {{ rental.razorpay_payment_id }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No rental history available.
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript functions -->
    <script>
        function initiateRental(equipmentId) {
            window.location.href = `/rental/calculate/${equipmentId}/`;
        }

        function makePayment(rentalId) {
            fetch(`/confirm-rental-payment/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ rental_id: rentalId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Payment failed');
                }
            });
        }

        // Add function to check rental status periodically
        function checkRentalStatus() {
            const pendingButtons = document.querySelectorAll('.btn-warning[disabled]');
            if (pendingButtons.length > 0) {
                fetch('/api/check-rental-status/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status_changed) {
                            location.reload();
                        }
                    });
            }
        }

        // Check status every 30 seconds
        setInterval(checkRentalStatus, 30000);
    </script>

    <!-- Add this JavaScript for map functionality -->
    <script>
    const deliveryMaps = {};
    const deliveryMarkers = {};

    function initializeMap(deliveryId, deliveryLat, deliveryLng) {
        const mapElement = document.getElementById(`map-${deliveryId}`);
        if (!mapElement) return;

        const map = new google.maps.Map(mapElement, {
            zoom: 15,
            center: { lat: deliveryLat, lng: deliveryLng }
        });

        // Add delivery location marker
        new google.maps.Marker({
            position: { lat: deliveryLat, lng: deliveryLng },
            map: map,
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        });

        // Add volunteer marker
        const volunteerMarker = new google.maps.Marker({
            map: map,
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        });

        deliveryMaps[deliveryId] = map;
        deliveryMarkers[deliveryId] = volunteerMarker;
    }

    function updateVolunteerLocation(deliveryId, lat, lng) {
        const marker = deliveryMarkers[deliveryId];
        const map = deliveryMaps[deliveryId];
        if (marker && map) {
            const position = new google.maps.LatLng(lat, lng);
            marker.setPosition(position);
            map.panTo(position);
        }
    }

    // Poll for location updates
    function pollDeliveryUpdates() {
        const activeDeliveries = document.querySelectorAll('.delivery-map');
        activeDeliveries.forEach(mapDiv => {
            const deliveryId = mapDiv.id.split('-')[1];
            fetch(`/api/delivery/${deliveryId}/location/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateVolunteerLocation(
                            deliveryId,
                            data.latitude,
                            data.longitude
                        );
                    }
                });
        });
    }

    // Start polling when page loads
    setInterval(pollDeliveryUpdates, 30000); // Update every 30 seconds
    </script>

    <script>
    function updateUsageDetails(rentalId) {
        fetch(`/api/rental/${rentalId}/usage-details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Calculate days between start date and today or end date
                    const startDate = new Date(data.rental_start_date);
                    const endDate = new Date(data.rental_end_date);
                    const today = new Date();
                    
                    // Use the earlier of today or end date
                    const currentDate = today < endDate ? today : endDate;
                    
                    // Calculate days elapsed (including the current day)
                    const daysElapsed = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calculate current amount based on days elapsed
                    const dailyRate = parseFloat(data.daily_rate);
                    const currentAmount = daysElapsed * dailyRate;
                    
                    // Update the display
                    const durationElement = document.getElementById(`usage-duration-${rentalId}`);
                    if (durationElement) {
                        durationElement.textContent = daysElapsed;
                    }

                    const amountElement = document.getElementById(`current-amount-${rentalId}`);
                    if (amountElement) {
                        amountElement.textContent = currentAmount.toFixed(2);
                    }
                }
            })
            .catch(error => console.error('Error updating usage details:', error));
    }

    // Update usage details every day at midnight
    function scheduleNextUpdate() {
        const now = new Date();
        const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        const timeUntilMidnight = tomorrow - now;
        
        setTimeout(() => {
            updateAllUsageDetails();
            scheduleNextUpdate();
        }, timeUntilMidnight);
    }

    // Update all rentals when page loads
    document.addEventListener('DOMContentLoaded', () => {
        updateAllUsageDetails();
        scheduleNextUpdate();
        
        // Also update every hour to handle any changes
        setInterval(updateAllUsageDetails, 3600000); // 1 hour
    });

    function updateAllUsageDetails() {
        document.querySelectorAll('[data-rental-id]').forEach(element => {
            const rentalId = element.dataset.rentalId;
            updateUsageDetails(rentalId);
        });
    }
    </script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Add this JavaScript code right before the closing </body> tag -->
    <script>
    // Function to update usage details for all active rentals
    function updateAllUsageDetails() {
        document.querySelectorAll('[id^="usage-duration-"]').forEach(element => {
            const rentalId = element.id.split('-').pop();
            updateUsageDetails(rentalId);
        });
    }

    // Function to update usage details for a specific rental
    function updateUsageDetails(rentalId) {
        fetch(`/api/rental/${rentalId}/usage-details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update usage duration
                    const durationElement = document.getElementById(`usage-duration-${rentalId}`);
                    if (durationElement) {
                        durationElement.textContent = data.duration;
                    }

                    // Update current bill amount
                    const amountElement = document.getElementById(`current-amount-${rentalId}`);
                    if (amountElement) {
                        amountElement.textContent = data.amount;
                    }

                    // Update last updated timestamp
                    const lastUpdatedElement = document.getElementById(`last-updated-${rentalId}`);
                    if (lastUpdatedElement) {
                        lastUpdatedElement.textContent = new Date().toLocaleString();
                    }

                    // Update usage history if available
                    if (data.history && data.history.length > 0) {
                        updateUsageHistory(rentalId, data.history);
                    }
                }
            })
            .catch(error => console.error('Error updating usage details:', error));
    }

    // Update usage details when page loads
    document.addEventListener('DOMContentLoaded', () => {
        updateAllUsageDetails();
        
        // Update every minute
        setInterval(updateAllUsageDetails, 60000);
    });
    </script>

    <script>
    function checkRentalStatus(rentalId) {
        fetch(`/api/rental/${rentalId}/usage-details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const actionsDiv = document.querySelector(`#rental-${rentalId} .usage-actions`);
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (data.rental_end_date <= today) {
                        actionsDiv.innerHTML = `
                            <h6>Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary mb-2" onclick="payRentalBill(${rentalId})">
                                    <i class="fas fa-money-bill me-2"></i> Pay Rental Bill
                                    <span class="badge bg-light text-dark ms-2">₹${data.amount}</span>
                                </button>
                                
                                <button class="btn btn-warning mb-2" onclick="requestRentalExtension(${rentalId})">
                                    <i class="fas fa-clock me-2"></i> Extend Rental Period
                                </button>
                                
                                <div class="alert alert-warning">
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        Your rental period has ended. Please either pay the bill or request an extension.
                                    </small>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Update usage details
                    document.getElementById(`usage-duration-${rentalId}`).textContent = data.duration;
                    document.getElementById(`current-amount-${rentalId}`).textContent = data.amount;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Check rental status when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const rentalCards = document.querySelectorAll('[id^="rental-"]');
        rentalCards.forEach(card => {
            const rentalId = card.id.split('-')[1];
            checkRentalStatus(rentalId);
        });
    });

    // Check rental status every minute
    setInterval(() => {
        const rentalCards = document.querySelectorAll('[id^="rental-"]');
        rentalCards.forEach(card => {
            const rentalId = card.id.split('-')[1];
            checkRentalStatus(rentalId);
        });
    }, 60000);
    </script>

    <script>
    function payRentalBill(rentalId) {
        // Check if Razorpay script is loaded
        if (typeof Razorpay === 'undefined') {
            // Dynamically load Razorpay script
            const script = document.createElement('script');
            script.src = 'https://checkout.razorpay.com/v1/checkout.js';
            script.onload = () => initializeRazorpayPayment(rentalId);
            script.onerror = () => {
        Swal.fire({
                    icon: 'error',
                    title: 'Payment Error',
                    text: 'Failed to load payment gateway. Please check your internet connection.'
                });
            };
            document.head.appendChild(script);
            return;
        }

        // If Razorpay is already loaded, proceed with payment
        initializeRazorpayPayment(rentalId);
    }

    function initializeRazorpayPayment(rentalId) {
        // Fetch final amount details first
        fetch(`/api/rental/${rentalId}/final-amount/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(amountData => {
            console.log('Amount Data:', amountData);  // Detailed logging
            
            if (amountData.success) {
                // Then fetch Razorpay order details
                return fetch(`/rental/${rentalId}/payment/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(orderData => {
                    console.log('Order Data:', orderData);  // Detailed logging
                    
                    if (orderData.success) {
                        // Explicitly log the amount
                        console.log('Calculated Amount:', amountData.amount);
                        console.log('Amount Type:', typeof amountData.amount);
                        
                        // Ensure amount is a number
                        const amount = parseFloat(amountData.amount);
                        console.log("amount",amount)
                        const options = {
                            key: '{{ razorpay_key }}',
                            amount: amount * 100,  // Convert to paise
                            currency: 'INR',
                            name: 'CareFusion',
                            description: 'Rental Payment',
                            order_id: orderData.order_id,
                            handler: function(response) {
                                // Redirect to verify payment
                                window.location.href = `/rental/verify-payment/?payment_id=${response.razorpay_payment_id}&order_id=${response.razorpay_order_id}&signature=${response.razorpay_signature}`;
                            },
                            prefill: {
                                name: '{{ rental.patient.get_full_name }}',
                                email: '{{ rental.patient.email }}'
                            },
                            theme: {
                                color: '#4e73df'
                            },
                            modal: {
                                ondismiss: function() {
                                    // Redirect if payment is cancelled
                                    window.location.href = "/patient/rentals/";
                                }
                            }
                        };

                        // Create detailed payment summary
                        const paymentSummary = `
                            <div class="payment-details">
                                <p><strong>Rental Period:</strong> ${amountData.start_date} to ${amountData.end_date}</p>
                                <p><strong>Total Days:</strong> ${amountData.days} days</p>
                                <p><strong>Daily Rate:</strong> ₹${amountData.daily_rate}</p>
                                <p><strong>Total Amount:</strong> ₹${amount.toFixed(2)}</p>
                    </div>
                        `;

                        // Confirm payment details before Razorpay checkout
                        Swal.fire({
                            title: 'Confirm Rental Payment',
                            html: paymentSummary,
            showCancelButton: true,
            confirmButtonText: 'Proceed to Payment',
            cancelButtonText: 'Cancel',
                            preConfirm: () => {
                                // Initialize and open Razorpay checkout
                                const rzp = new Razorpay(options);
                                rzp.open();
                            }
                        });
                    } else {
                        throw new Error(orderData.error || 'Could not create payment order');
                    }
                });
            } else {
                throw new Error(amountData.error || 'Could not fetch payment details');
            }
        })
        .catch(error => {
            console.error('Payment initialization error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Payment Error', 
                text: error.message || 'Could not process payment'
            });
        });
    }

    function requestRentalExtension(rentalId) {
        console.log('Extension requested for rental:', rentalId); // Debug log

        Swal.fire({
            title: 'Request Rental Extension',
            html: `
                <form id="extensionForm">
                    <div class="form-group">
                        <label>Number of Days</label>
                        <input type="number" id="extension-days" class="form-control" min="1" max="30" value="7">
                    </div>
                    <div class="form-group mt-3">
                        <label>Reason for Extension</label>
                        <textarea id="extension-reason" class="form-control" rows="3" placeholder="Please provide a reason for the extension"></textarea>
                    </div>
                </form>
            `,
            showCancelButton: true,
            confirmButtonText: 'Submit Request',
            cancelButtonText: 'Cancel',
            preConfirm: () => {
                const days = document.getElementById('extension-days').value;
                const reason = document.getElementById('extension-reason').value;
                
                if (!days || !reason) {
                    Swal.showValidationMessage('Please fill in all fields');
                    return false;
                }
                
                return {
                    days: parseInt(days),
                    reason: reason.trim()
                };
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch('/api/rental/request-extension/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        rental_id: rentalId,
                        days: result.value.days,
                        reason: result.value.reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Request Submitted',
                            text: 'Your extension request has been submitted for review.'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        throw new Error(data.error || 'Failed to submit extension request');
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to submit extension request'
                    });
                });
            }
        });
    }

    // Add this to your existing DOMContentLoaded event listener
    document.addEventListener('DOMContentLoaded', () => {
        // ... existing code ...
        
        // Check rental end dates and update UI
        document.querySelectorAll('[data-rental-end-date]').forEach(element => {
            const endDate = new Date(element.dataset.rentalEndDate);
            const today = new Date();
            if (endDate <= today) {
                element.closest('.rental-card').classList.add('rental-expired');
            }
        });
    });
    </script>

    <!-- Add this to your existing JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check all rentals on page load
        document.querySelectorAll('[data-rental-id]').forEach(element => {
            const rentalId = element.dataset.rentalId;
            updateUsageDetails(rentalId);
        });
    });
    </script>

    <!-- Add this function to check rental status on page load -->
    <script>
    function checkRentalStatus(rentalId) {
        fetch(`/api/rental/${rentalId}/usage-details/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Rental status:', data.status);
                    console.log('End date:', data.rental_end_date);
                    
                    const actionsDiv = document.querySelector(`#rental-${rentalId} .usage-actions`);
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (data.rental_end_date <= today) {
                        actionsDiv.innerHTML = `
                            <h6>Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary mb-2" onclick="payRentalBill(${rentalId})">
                                    <i class="fas fa-money-bill me-2"></i> Pay Rental Bill
                                    <span class="badge bg-light text-dark ms-2">₹${data.amount}</span>
                                </button>
                                
                                <button class="btn btn-warning mb-2" onclick="requestRentalExtension(${rentalId})">
                                    <i class="fas fa-clock me-2"></i> Extend Rental Period
                                </button>
                                
                                <div class="alert alert-warning">
                                    <small>
                                        <i class="fas fa-info-circle me-2"></i>
                                        Your rental period has ended. Please either pay the bill or request an extension.
                                    </small>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Update usage details
                    document.getElementById(`usage-duration-${rentalId}`).textContent = data.duration;
                    document.getElementById(`current-amount-${rentalId}`).textContent = data.amount;
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Check rental status when page loads
    document.addEventListener('DOMContentLoaded', function() {
        const rentalCards = document.querySelectorAll('[id^="rental-"]');
        rentalCards.forEach(card => {
            const rentalId = card.id.split('-')[1];
            checkRentalStatus(rentalId);
        });
    });

    // Check rental status every minute
    setInterval(() => {
        const rentalCards = document.querySelectorAll('[id^="rental-"]');
        rentalCards.forEach(card => {
            const rentalId = card.id.split('-')[1];
            checkRentalStatus(rentalId);
        });
    }, 60000);
    </script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // Rest of your existing script
    </script>
</body>
</html> 
{% endblock %} 